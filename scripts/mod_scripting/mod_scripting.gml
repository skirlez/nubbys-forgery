#macro GMLspeak global.__GMLspeak__
function initialize_catspeak_gmlspeak() {
	catspeak_force_init();
	global.__GMLspeak__ = new GMLspeakEnvironment();
	GMLspeak.enableSharedGlobal(false)
	global.disallowed_functions_set = hashset_create();
	put_disallowed_functions(global.disallowed_functions_set)
	// One of the goals of this project is to not limit what mods can do.
	// The worst thing enabling this can do is allow mods to delete saved scores,
	// but since scores are saved in a different folder, and GameMaker has a sandboxed filesystem,
	// your base game scores cannot be touched.
	
	// (This causes an Ubuntu crash. IDK why. The real game is on proton on steam anyways so who cares.)
	Catspeak.interface.exposeEverythingIDontCareIfModdersCanEditUsersSaveFilesJustLetMeDoThis = true;
	GMLspeak.interface.exposeEverythingIDontCareIfModdersCanEditUsersSaveFilesJustLetMeDoThis = true;
	
	expose_constants(Catspeak.interface)
	expose_constants(GMLspeak.interface)
	
	GMLspeak.interface.compileFlags.checkForVariables = true;
}

function expose_constants(interface) {
	interface.exposeConstant("mod_resource_item", mod_resources.item)
	interface.exposeConstant("mod_resource_perk", mod_resources.perk)
	interface.exposeConstant("mod_resource_supervisor", mod_resources.supervisor)
}


function compile_code_file(path) {
	var type = mod_get_code_type(path)
	var buffer = buffer_load(path)
	var ir;
	var main;
	if type == code_file_types.gml {
		ir = GMLspeak.parse(buffer)
		main = GMLspeak.compile(ir);
	}
	else if type == code_file_types.catspeak {
		ir = Catspeak.parse(buffer);
		main = Catspeak.compile(ir);
	}

	buffer_delete(buffer)
	return main;
}

function execute(code, args = undefined) {
	if !is_array(args)
		args = [args]
	return catspeak_execute_ext(code, catspeak_globals(code), args)
}


// generated by projectscripts/meta/generate_get_disallowed_functions.py
function put_disallowed_functions(hashset) {
	hashset_put(hashset, "__gmlspeak_error")
	hashset_put(hashset, "registry_create")
	hashset_put(hashset, "registry_destroy")
	hashset_put(hashset, "registry_clear")
	hashset_put(hashset, "registry_clear_type")
	hashset_put(hashset, "CatspeakASGBuilder")
	hashset_put(hashset, "CatspeakIRBuilder")
	hashset_put(hashset, "__catspeak_term_is_pure")
	hashset_put(hashset, "__catspeak_term_get_terminal")
	hashset_put(hashset, "__catspeak_operator_from_token")
	hashset_put(hashset, "__catspeak_operator_assign_from_token")
	hashset_put(hashset, "__catspeak_operator_get_binary")
	hashset_put(hashset, "__catspeak_operator_get_unary")
	hashset_put(hashset, "__catspeak_op_remainder")
	hashset_put(hashset, "__catspeak_op_multiply")
	hashset_put(hashset, "__catspeak_op_divide")
	hashset_put(hashset, "__catspeak_op_divide_int")
	hashset_put(hashset, "__catspeak_op_subtract")
	hashset_put(hashset, "__catspeak_op_plus")
	hashset_put(hashset, "__catspeak_op_equal")
	hashset_put(hashset, "__catspeak_op_not_equal")
	hashset_put(hashset, "__catspeak_op_greater")
	hashset_put(hashset, "__catspeak_op_greater_equal")
	hashset_put(hashset, "__catspeak_op_less")
	hashset_put(hashset, "__catspeak_op_less_equal")
	hashset_put(hashset, "__catspeak_op_shift_right")
	hashset_put(hashset, "__catspeak_op_shift_left")
	hashset_put(hashset, "__catspeak_op_bitwise_and")
	hashset_put(hashset, "__catspeak_op_bitwise_xor")
	hashset_put(hashset, "__catspeak_op_bitwise_or")
	hashset_put(hashset, "__catspeak_op_xor")
	hashset_put(hashset, "__catspeak_op_subtract_unary")
	hashset_put(hashset, "__catspeak_op_plus_unary")
	hashset_put(hashset, "__catspeak_op_not_unary")
	hashset_put(hashset, "__catspeak_op_bitwise_not_unary")
	hashset_put(hashset, "__catspeak_init_operators")
	hashset_put(hashset, "is_gmlspeak")
	hashset_put(hashset, "__gmlspeak_log")
	hashset_put(hashset, "__gmlspeak_method__")
	hashset_put(hashset, "save_forgery_autosave")
	hashset_put(hashset, "load_button_is_save_loadable")
	hashset_put(hashset, "load_button_create_message")
	hashset_put(hashset, "parse_autosave_array")
	hashset_put(hashset, "write_autosave_array")
	hashset_put(hashset, "load_forgery_autosave")
	hashset_put(hashset, "find_string_id_from_data")
	hashset_put(hashset, "get_struct_compliance_with_contract")
	hashset_put(hashset, "generate_discompliance_error_text")
	hashset_put(hashset, "initialize_missing")
	hashset_put(hashset, "__catspeak_infer_function_name")
	hashset_put(hashset, "is_catspeak")
	hashset_put(hashset, "__catspeak_timeout_check")
	hashset_put(hashset, "CatspeakGMLCompiler")
	hashset_put(hashset, "__catspeak_function__")
	hashset_put(hashset, "__catspeak_expr_value__")
	hashset_put(hashset, "__catspeak_expr_array__")
	hashset_put(hashset, "__catspeak_expr_struct__")
	hashset_put(hashset, "__catspeak_expr_block__")
	hashset_put(hashset, "__catspeak_expr_block_2__")
	hashset_put(hashset, "__catspeak_expr_block_3__")
	hashset_put(hashset, "__catspeak_expr_block_4__")
	hashset_put(hashset, "__catspeak_expr_block_5__")
	hashset_put(hashset, "__catspeak_expr_if__")
	hashset_put(hashset, "__catspeak_expr_if_else__")
	hashset_put(hashset, "__catspeak_expr_catch__")
	hashset_put(hashset, "__catspeak_expr_and__")
	hashset_put(hashset, "__catspeak_expr_or__")
	hashset_put(hashset, "__catspeak_expr_loop_while__")
	hashset_put(hashset, "__catspeak_expr_loop_for__")
	hashset_put(hashset, "__catspeak_expr_loop_do__")
	hashset_put(hashset, "__catspeak_expr_loop_general__")
	hashset_put(hashset, "__catspeak_expr_loop_with__")
	hashset_put(hashset, "__catspeak_expr_match__")
	hashset_put(hashset, "__catspeak_expr_while_simple__")
	hashset_put(hashset, "__catspeak_expr_return__")
	hashset_put(hashset, "__catspeak_expr_break__")
	hashset_put(hashset, "__catspeak_expr_continue__")
	hashset_put(hashset, "__catspeak_expr_throw__")
	hashset_put(hashset, "__catspeak_expr_op_1__")
	hashset_put(hashset, "__catspeak_expr_op_2__")
	hashset_put(hashset, "__catspeak_script_execute_ext_fixed")
	hashset_put(hashset, "__catspeak_expr_call_method__")
	hashset_put(hashset, "__catspeak_expr_call__")
	hashset_put(hashset, "__catspeak_expr_call_0__")
	hashset_put(hashset, "__catspeak_expr_call_1__")
	hashset_put(hashset, "__catspeak_expr_call_2__")
	hashset_put(hashset, "__catspeak_expr_call_3__")
	hashset_put(hashset, "__catspeak_expr_call_4__")
	hashset_put(hashset, "__catspeak_expr_call_5__")
	hashset_put(hashset, "__catspeak_expr_call_new__")
	hashset_put(hashset, "__catspeak_expr_index_get__")
	hashset_put(hashset, "__catspeak_expr_index_set__")
	hashset_put(hashset, "__catspeak_expr_index_set_mult__")
	hashset_put(hashset, "__catspeak_expr_index_set_div__")
	hashset_put(hashset, "__catspeak_expr_index_set_sub__")
	hashset_put(hashset, "__catspeak_expr_index_set_plus__")
	hashset_put(hashset, "__catspeak_expr_property_get__")
	hashset_put(hashset, "__catspeak_expr_property_set__")
	hashset_put(hashset, "__catspeak_expr_property_set_mult__")
	hashset_put(hashset, "__catspeak_expr_property_set_div__")
	hashset_put(hashset, "__catspeak_expr_property_set_sub__")
	hashset_put(hashset, "__catspeak_expr_property_set_plus__")
	hashset_put(hashset, "__catspeak_expr_global_get__")
	hashset_put(hashset, "__catspeak_expr_global_set__")
	hashset_put(hashset, "__catspeak_expr_global_set_mult__")
	hashset_put(hashset, "__catspeak_expr_global_set_div__")
	hashset_put(hashset, "__catspeak_expr_global_set_sub__")
	hashset_put(hashset, "__catspeak_expr_global_set_plus__")
	hashset_put(hashset, "__catspeak_expr_local_get__")
	hashset_put(hashset, "__catspeak_expr_local_set__")
	hashset_put(hashset, "__catspeak_expr_local_set_mult__")
	hashset_put(hashset, "__catspeak_expr_local_set_div__")
	hashset_put(hashset, "__catspeak_expr_local_set_sub__")
	hashset_put(hashset, "__catspeak_expr_local_set_plus__")
	hashset_put(hashset, "__catspeak_expr_self__")
	hashset_put(hashset, "__catspeak_expr_other__")
	hashset_put(hashset, "__catspeak_expr_params_get__")
	hashset_put(hashset, "__catspeak_expr_params_count_get__")
	hashset_put(hashset, "__catspeak_init_codegen")
	hashset_put(hashset, "get_all_files")
	hashset_put(hashset, "get_all_directories")
	hashset_put(hashset, "remove_file_extension")
	hashset_put(hashset, "get_file_extension")
	hashset_put(hashset, "log_error")
	hashset_put(hashset, "log_warn")
	hashset_put(hashset, "log_info")
	hashset_put(hashset, "log_udp")
	hashset_put(hashset, "__catspeak_get_gml_interface")
	hashset_put(hashset, "__catspeak_preset_get")
	hashset_put(hashset, "__catspeak_preset_type")
	hashset_put(hashset, "__catspeak_preset_array")
	hashset_put(hashset, "__catspeak_preset_struct")
	hashset_put(hashset, "__catspeak_preset_string")
	hashset_put(hashset, "__catspeak_preset_math")
	hashset_put(hashset, "__catspeak_preset_math_3d")
	hashset_put(hashset, "__catspeak_preset_colour")
	hashset_put(hashset, "__catspeak_preset_draw")
	hashset_put(hashset, "__catspeak_preset_random")
	hashset_put(hashset, "__catspeak_preset_unsafe")
	hashset_put(hashset, "catspeak_preset_add")
	hashset_put(hashset, "__catspeak_init_presets")
	hashset_put(hashset, "initialize_catspeak_gmlspeak")
	hashset_put(hashset, "expose_constants")
	hashset_put(hashset, "compile_code_file")
	hashset_put(hashset, "execute")
	hashset_put(hashset, "put_disallowed_functions")
	hashset_put(hashset, "GMLspeakCodegen")
	hashset_put(hashset, "__gmlspeak_expr_index_check__")
	hashset_put(hashset, "__gmlspeak_expr_index_check_hash__")
	hashset_put(hashset, "__gmlspeak_expr_index_get_hash__")
	hashset_put(hashset, "__gmlspeak_expr_index_set_hash__")
	hashset_put(hashset, "__gmlspeak_expr_index_set_mult_hash__")
	hashset_put(hashset, "__gmlspeak_expr_index_set_div_hash__")
	hashset_put(hashset, "__gmlspeak_expr_index_set_sub_hash__")
	hashset_put(hashset, "__gmlspeak_expr_index_set_plus_hash__")
	hashset_put(hashset, "allocate_object")
	hashset_put(hashset, "free_all_allocated_objects")
	hashset_put(hashset, "get_resource_allocated_to_object")
	hashset_put(hashset, "register_perks_for_gameplay")
	hashset_put(hashset, "GMLspeakParser")
	hashset_put(hashset, "hashset_create")
	hashset_put(hashset, "hashset_destroy")
	hashset_put(hashset, "hashset_size")
	hashset_put(hashset, "hashset_elements_array")
	hashset_put(hashset, "hashset_put")
	hashset_put(hashset, "hashset_contains")
	hashset_put(hashset, "hashset_clear")
	hashset_put(hashset, "hashset_delete")
	hashset_put(hashset, "bimap_create")
	hashset_put(hashset, "bimap_size")
	hashset_put(hashset, "bimap_get_left")
	hashset_put(hashset, "bimap_get_right")
	hashset_put(hashset, "bimap_set")
	hashset_put(hashset, "bimap_delete_left")
	hashset_put(hashset, "bimap_delete_right")
	hashset_put(hashset, "bimap_delete")
	hashset_put(hashset, "bimap_clear")
	hashset_put(hashset, "bimap_destroy")
	hashset_put(hashset, "bimap_lefts_array")
	hashset_put(hashset, "bimap_rights_array")
	hashset_put(hashset, "bimap_left_exists")
	hashset_put(hashset, "bimap_right_exists")
	hashset_put(hashset, "CatspeakParser")
	hashset_put(hashset, "register_supervisors_for_gameplay")
	hashset_put(hashset, "register_supervisor_for_gameplay")
	hashset_put(hashset, "create_mod_supervisor_object")
	hashset_put(hashset, "register_supervisors_sprites_for_gameplay")
	hashset_put(hashset, "on_supervisor_preview_choose_clicked_audio")
	hashset_put(hashset, "clear_index_assignments")
	hashset_put(hashset, "assign_index_to_resource")
	hashset_put(hashset, "CatspeakForeignInterface")
	hashset_put(hashset, "CatspeakEnvironment")
	hashset_put(hashset, "catspeak_special_to_struct")
	hashset_put(hashset, "catspeak_execute")
	hashset_put(hashset, "catspeak_execute_ext")
	hashset_put(hashset, "catspeak_globals")
	hashset_put(hashset, "catspeak_method")
	hashset_put(hashset, "catspeak_get_self")
	hashset_put(hashset, "catspeak_get_index")
	hashset_put(hashset, "__catspeak_function_method__")
	hashset_put(hashset, "__catspeak_init_engine")
	hashset_put(hashset, "GMLspeakLexer")
	hashset_put(hashset, "__gmlspeak_is_token")
	hashset_put(hashset, "catspeak_collect")
	hashset_put(hashset, "__catspeak_alloc")
	hashset_put(hashset, "__catspeak_alloc_ds_map")
	hashset_put(hashset, "__catspeak_alloc_ds_list")
	hashset_put(hashset, "__catspeak_alloc_ds_stack")
	hashset_put(hashset, "__catspeak_alloc_ds_priority")
	hashset_put(hashset, "__catspeak_init_alloc")
	hashset_put(hashset, "catspeak_location_create")
	hashset_put(hashset, "catspeak_location_get_row")
	hashset_put(hashset, "catspeak_location_get_column")
	hashset_put(hashset, "__catspeak_location_show")
	hashset_put(hashset, "__catspeak_location_show_ext")
	hashset_put(hashset, "__catspeak_is_withable")
	hashset_put(hashset, "__catspeak_is_callable")
	hashset_put(hashset, "__catspeak_is_nullish")
	hashset_put(hashset, "__catspeak_string")
	hashset_put(hashset, "__catspeak_error")
	hashset_put(hashset, "__catspeak_error_silent")
	hashset_put(hashset, "__catspeak_error_got")
	hashset_put(hashset, "__catspeak_error_bug")
	hashset_put(hashset, "__catspeak_error_unimplemented")
	hashset_put(hashset, "__catspeak_error_deprecated")
	hashset_put(hashset, "__catspeak_check_init")
	hashset_put(hashset, "__catspeak_infer_type_from_predicate")
	hashset_put(hashset, "__catspeak_check_arg")
	hashset_put(hashset, "__catspeak_check_arg_optional")
	hashset_put(hashset, "__catspeak_check_arg_not")
	hashset_put(hashset, "__catspeak_check_arg_struct")
	hashset_put(hashset, "__catspeak_check_arg_struct_instanceof")
	hashset_put(hashset, "__catspeak_check_arg_size_bits")
	hashset_put(hashset, "__catspeak_check_global_exists")
	hashset_put(hashset, "catspeak_force_init")
	hashset_put(hashset, "on_game_event")
	hashset_put(hashset, "create_mod")
	hashset_put(hashset, "compile_all_files_in_path_recursively")
	hashset_put(hashset, "strip_initial_path_separator_character")
	hashset_put(hashset, "unload_mod")
	hashset_put(hashset, "clear_all_mods")
	hashset_put(hashset, "read_all_mods")
	hashset_put(hashset, "is_console_and_devmode_enabled")
	hashset_put(hashset, "reroll_cheats_enabled")
	hashset_put(hashset, "pretty_error")
	hashset_put(hashset, "hot_reload")
	hashset_put(hashset, "get_nf_version_string")
	hashset_put(hashset, "get_nf_loaded_string")
	hashset_put(hashset, "load_mod_translations")
	hashset_put(hashset, "append_mod_translations")
	hashset_put(hashset, "empty_function")
	hashset_put(hashset, "register_items_for_gameplay")
	hashset_put(hashset, "__catspeak_is_token")
	hashset_put(hashset, "__catspeak_create_buffer_from_string")
	hashset_put(hashset, "CatspeakLexer")
	hashset_put(hashset, "__catspeak_init_lexer")
	hashset_put(hashset, "__catspeak_char_is_digit")
	hashset_put(hashset, "__catspeak_char_is_digit_binary")
	hashset_put(hashset, "__catspeak_char_binary_to_dec")
	hashset_put(hashset, "__catspeak_char_is_digit_hex")
	hashset_put(hashset, "__catspeak_char_hex_to_dec")
	hashset_put(hashset, "__catspeak_char_is_alphanumeric")
	hashset_put(hashset, "__catspeak_char_is_operator")
	hashset_put(hashset, "__catspeak_char_is_whitespace")
	hashset_put(hashset, "__catspeak_codepage_value")
	hashset_put(hashset, "__catspeak_codepage_range")
	hashset_put(hashset, "__catspeak_codepage_set")
	hashset_put(hashset, "__catspeak_init_lexer_codepage")
	hashset_put(hashset, "__catspeak_keywords_create")
	hashset_put(hashset, "__catspeak_keywords_rename")
	hashset_put(hashset, "__catspeak_keywords_find_name")
	hashset_put(hashset, "__catspeak_init_lexer_keywords")
	hashset_put(hashset, "optional_empty")
	hashset_put(hashset, "optional_value")
	hashset_put(hashset, "result_ok")
	hashset_put(hashset, "result_error")
	hashset_put(hashset, "generic_error")
	hashset_put(hashset, "error_with_id")
	hashset_put(hashset, "GMLspeakEnvironment")
}


